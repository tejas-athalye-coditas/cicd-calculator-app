pipeline {
    agent { label "new-bond-agent" }

    environment {
        AWS_REGION="ap-south-1"
        ECR_REPO = "aws_ecr_repo_name"
        IMAGE_TAG = "build-${env.BUILD_NUMBER}"
        CONTAINER_NAME = "nextjs_calculator_app"
        AWS_CREDENTIALS = "aws_new_ac"
    }

    stages {
        stage('Checkout') {
            steps {
                git url: "https://github.com/tejas-athalye-coditas/cicd-calculator-app", branch: "main"
            }
        }

        stage('Authenticate ECR') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: "${AWS_CREDENTIALS}"]]) {
                    sh """
                        export PATH=$PATH:/usr/local/bin
                        aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO}
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${ECR_REPO}:${IMAGE_TAG} -f Dockerfile ."
            }
        }

        stage('Push to ECR') {
            steps {
                sh "docker push ${ECR_REPO}:${IMAGE_TAG}"
                sh "docker tag ${ECR_REPO}:${IMAGE_TAG} ${ECR_REPO}:latest"
                sh "docker push ${ECR_REPO}:latest"
            }
        }

        stage('Deploy on Agent') {
            steps {
                sh """
                    docker stop ${CONTAINER_NAME} || true
                    docker rm ${CONTAINER_NAME} || true
                    docker pull ${ECR_REPO}:${IMAGE_TAG}
                    docker run -d --name ${CONTAINER_NAME} -p 81:80 --restart always ${ECR_REPO}:${IMAGE_TAG}
                """
            }
        }
    }

    post {
        success {
            googlechatnotification(
                url: "id:gchat-jenkins-webhook",
                message: "${env.JOB_NAME}: Build #${env.BUILD_NUMBER} → SUCCESS"
            )
        }
        failure {
            googlechatnotification(
                url: "id:gchat-jenkins-webhook",
                message: "${env.JOB_NAME}: Build #${env.BUILD_NUMBER} → FAILED"
            )
        }
    }
}
